<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>generic_iterators: The Typeclass Pattern</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>

<link href="doxygen.css" rel="stylesheet" type="text/css" />

</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">generic_iterators
   &#160;<span id="projectnumber">1.0.0</span>
   </div>
   <div id="projectbrief">Demonstration of implementing and using type safe generic iterators in pure, standard C</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_Typeclass_Pattern.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle">
<div class="title">The Typeclass Pattern </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p class="">This document aims to describe the typeclass (or trait, or interface) based polymorphism pattern used.</p>
<h1>Goals</h1>
<p class="">Alongside describing the core parts of this pattern, this document will also describe how to <b>combine multiple typeclass constraints into one constraint</b>. As in, how you can have a type that is required to implement multiple typeclasses.</p>
<h1>Brief</h1>
<p class="">Function pointer based polymorphism isn't new to C by any means. The major difference in the typeclass pattern, and the typical vtable based approach is simply that typeclasses are based around actions, rather than objects. This is very similar to an interface in OOP terms.</p>
<h1>Core parts</h1>
<p class="">There are 3 core parts to this pattern-</p><ul>
<li>The typeclass struct definition</li>
<li>The typeclass instance struct definition</li>
<li>The macro used to implement the typeclass for a type in a **"type safe" way**</li>
</ul>
<p class="">We'll use these 3 parts to implement another typeclass - <a href="https://hackage.haskell.org/package/base-4.15.0.0/docs/Text-Show.html#t:Show"><code>Show</code></a>.</p>
<h2>The <code>typeclass</code> struct definition</h2>
<p class="">This is pretty simple, use the <code>typeclass</code> macro to pass the necessary function member for <code>Show</code>. We'll just be using the <code>show</code> function here, it takes in a type for which <code>Show</code> is implemented (i.e the <code>self</code>) and returns a printable string. </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <a class="code" href="typeclass_8h.html#ab36f9f0d3603452a867a683078618034">typeclass</a>(<span class="keywordtype">char</span>* (*<span class="keyword">const</span> show)(<span class="keywordtype">void</span>* <span class="keyword">self</span>)) Show;</div>
<div class="ttc" id="atypeclass_8h_html_ab36f9f0d3603452a867a683078618034"><div class="ttname"><a href="typeclass_8h.html#ab36f9f0d3603452a867a683078618034">typeclass</a></div><div class="ttdeci">#define typeclass(funcs)</div><div class="ttdoc">Define a typeclass with the given functions.</div><div class="ttdef"><b>Definition:</b> typeclass.h:23</div></div>
</div><!-- fragment --><p> You can also define it manually, without the macro- </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span>* (*<span class="keyword">const</span> show)(<span class="keywordtype">void</span>* <span class="keyword">self</span>);</div>
<div class="line">} Show;</div>
</div><!-- fragment --><p> A simple struct containing the "virtual functions". When the wrapper function is first called (to convert a certain type to its typeclass instance), a typeclass struct of <code>static</code> storage duration is created with the function pointers for that specific type (a vtable of sorts). The pointer to this struct is then used in all typeclass instances.</p>
<h2>The <code>typeclass_instance</code> struct definition</h2>
<p class="">This is the concrete instance to be used as a type constraint. It should contain a pointer to the typeclass, and the <code>self</code> member as a void pointer.</p>
<p class="">You can use the <code>typeclass_instance</code> macro to define this struct- </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <a class="code" href="typeclass_8h.html#af018200b2431a3ab6c296cc8940ecbe3">typeclass_instance</a>(Show) Showable;</div>
<div class="ttc" id="atypeclass_8h_html_af018200b2431a3ab6c296cc8940ecbe3"><div class="ttname"><a href="typeclass_8h.html#af018200b2431a3ab6c296cc8940ecbe3">typeclass_instance</a></div><div class="ttdeci">#define typeclass_instance(Typeclass)</div><div class="ttdoc">Define a typeclass instance for the given typeclass.</div><div class="ttdef"><b>Definition:</b> typeclass.h:43</div></div>
</div><!-- fragment --><p> or manually- </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">void</span>* <span class="keyword">self</span>;</div>
<div class="line">    Show <span class="keyword">const</span>* <span class="keyword">const</span> tc;</div>
<div class="line">} Showable;</div>
</div><!-- fragment --> <h2>The <code>impl_</code> macro used to implement the typeclass</h2>
<p class="">This is the convenience macro that defines a function for a specific type that wraps it into the typeclass instance.</p>
<p class="">Here's some general rules about this macro-</p><ul>
<li>It should start with taking in the type name(s) of the type the implementation is for</li>
<li>It should then take the function implementation(s) to be used for that specific type</li>
<li>It should take in the name to define the wrapper function as</li>
<li><p class="startli">The defined function <b>must</b> store the function implementations given into function pointers of the expected type.</p>
<p class="startli">This can be a no-op typecheck. The expected types should replace the <code>void* self</code> with the concrete type the impl is for.</p>
</li>
<li>The defined function <b>must</b> take in an argument of the specific type, to wrap it into the typeclass instance</li>
<li>The defined function <b>must</b> define the typeclass as a <code>static</code> variable and store the function pointers in it.</li>
<li>The function should return the typeclass instance, putting in a pointer to the <code>static</code> typeclass as well as filling the <code>self</code> member with the function argument.</li>
</ul>
<p class="">Following these rules, this is what <code>impl_show</code> would look like- </p><div class="fragment"><div class="line"><span class="preprocessor">#define impl_show(T, Name, show_f)                                                                                     \</span></div>
<div class="line"><span class="preprocessor">    Showable Name(T x)                                                                                                 \</span></div>
<div class="line"><span class="preprocessor">    {                                                                                                                  \</span></div>
<div class="line"><span class="preprocessor">        char* (*const show_)(T e) = (show_f);                                                                          \</span></div>
<div class="line"><span class="preprocessor">        (void)show_;                                                                                                   \</span></div>
<div class="line"><span class="preprocessor">        static Show const tc = {.show = (char* (*const)(void*))(show_f) };                                             \</span></div>
<div class="line"><span class="preprocessor">        return (Showable){.tc = &amp;tc, .self = x};                                                                       \</span></div>
<div class="line"><span class="preprocessor">    }</span></div>
</div><!-- fragment --><p> It takes the <code>show</code> implementation as its third argument. In the function definition, it stores that impl in a variable of type <code>char* (*const show_)(T e)</code>, which is the exact type it should be - <code>T</code> is the specific type the implementation is for. It <b>must be a pointer type</b>. Since it's stored into <code>void* self</code>.</p>
<p class="">The <code>(void)show_;</code> line is to suppress the unused variable warning emitted by compilers. Since <code>show_</code> isn't actually used - it's only there for typechecking purposes. The 2 typechecking lines will be completely eliminated by any decent compiler.</p>
<p class="">Then it simply defines a static typeclass, stores the function pointer given and returns the <code>Showable</code> struct, wrapping the <code>x</code> argument within.</p>
<h1>Usage</h1>
<p class="">Once the typeclass and typeclass instance structs have been defined, all the user has to do is call <code>impl_iterator</code> with their own type and the function implementation(s) required for the typeclass. The declaration of the function defined by <code>impl_iterator</code> can then be included in a header. After that, that function can be used to turn the concrete type into its typeclass instance.</p>
<p class="">Here's an example of implementing the previously defined <code>Show</code> typeclass for an enum- </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></div>
<div class="line">{</div>
<div class="line">    holy,</div>
<div class="line">    hand,</div>
<div class="line">    grenade</div>
<div class="line">} Antioch;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">char</span>* strdup_(<span class="keywordtype">char</span> <span class="keyword">const</span>* x)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span>* s = malloc((strlen(x) + 1) * <span class="keyword">sizeof</span>(*s));</div>
<div class="line">    strcpy(s, x);</div>
<div class="line">    <span class="keywordflow">return</span> s;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span>* antioch_show(Antioch* x)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">switch</span> (*x)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">case</span> holy:</div>
<div class="line">            <span class="keywordflow">return</span> strdup_(<span class="stringliteral">&quot;holy&quot;</span>);</div>
<div class="line">        <span class="keywordflow">case</span> hand:</div>
<div class="line">            <span class="keywordflow">return</span> strdup_(<span class="stringliteral">&quot;hand&quot;</span>);</div>
<div class="line">        <span class="keywordflow">case</span> grenade:</div>
<div class="line">            <span class="keywordflow">return</span> strdup_(<span class="stringliteral">&quot;grenade&quot;</span>);</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            <span class="keywordflow">return</span> strdup_(<span class="stringliteral">&quot;breakfast cereal&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">impl_show(Antioch*, prep_antioch_show, antioch_show)</div>
</div><!-- fragment --><p> The signature of defined function should be- </p><div class="fragment"><div class="line">Showable prep_antioch_show(Antioch* x);</div>
</div><!-- fragment --><p class="">Now, you can convert an <code>Antioch</code> into a <code>Showable</code> like so- </p><div class="fragment"><div class="line">Antioch ant = holy;</div>
<div class="line">Showable antsh = prep_antioch_show(&amp;ant);</div>
</div><!-- fragment --><p class="">I also like to have the <code>print</code> function that just works on <code>Showable</code>s directly- </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> print(Showable showable)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *s = showable.show(showable.self);</div>
<div class="line">    puts(s);</div>
<div class="line">    free(s);</div>
<div class="line">}</div>
</div><!-- fragment --><p> You can now easily print an <code>Antioch</code> with these abstractions- </p><div class="fragment"><div class="line">Antioch ant = holy;</div>
<div class="line">print(prep_antioch_show(&amp;ant));</div>
</div><!-- fragment --><h1>Combining multiple typeclasses</h1>
<p class="">One of the core design goals of a typeclass is to be modular. A <code>Show</code> typeclass should only have actions directly related to "showing", a <code>Num</code> typeclass should only have actions directly related to numerical operations. Unlike objects, that may contain many different methods of arbitrary relevance to each other.</p>
<p class="">This means that, more often than not, you'll want a type that can do multiple different classes of actions. A type that implements multiple typeclasses.</p>
<p class="">You can model that pretty easily with this pattern- </p><div class="fragment"></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->

<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2 </li>
  </ul>
</div>


</body>
</html>
